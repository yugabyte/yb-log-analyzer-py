<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - YugabyteDB Log Analysis</title>
    <!-- Link Google Font: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">

    <style>
        /* YugabyteDB Color Palette Variables */
        :root {
            --yb-indigo: #1E154B; /* Primary Dark */
            --yb-purple: #735AF5; /* Primary Accent */
            --yb-orange: #FF5F3B; /* Primary Accent / Logomark */
            --yb-white: #FFFFFF;
            --yb-gray-1: #F5F5F7; /* Lightest Gray */
            --yb-gray-3: #E5E4EB; /* Light Gray for borders */
            --yb-gray-5: #C2C0CC; /* Medium Gray */
            --yb-gray-9: #615D6E; /* Dark Gray for text */
            --yb-gray-11: #282532; /* Darker Gray */
            --yb-black: #121017; /* Near Black */

            --font-primary: 'Inter', sans-serif;
            --font-headline: 'Inter', sans-serif; /* Use Inter SemiBold (600) */
        }

        /* Basic Reset & Body Styling */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-size: 100%; scroll-behavior: smooth; }
        body {
            font-family: var(--font-primary); font-weight: 400; line-height: 1.6;
            color: var(--yb-gray-11); background-color: var(--yb-gray-1);
            padding: 0; display: flex; flex-direction: column; min-height: 100vh;
        }

        /* Header Styling */
        .yb-header {
            background-color: var(--yb-indigo); color: var(--yb-white);
            padding: 0.75rem 2rem; display: flex; align-items: center; gap: 1rem;
        }
        .yb-logo-link { display: inline-flex; align-items: center; text-decoration: none; }
        .yb-logo-img { height: 32px; width: auto; vertical-align: middle; }

        /* Main Content Container */
        .container {
            max-width: 1300px; /* Even wider to accommodate combined date group */
            margin: 2rem auto; padding: 1.5rem 2rem;
            background-color: var(--yb-white); border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); flex-grow: 1;
        }

        /* Page Title */
        h2.page-title {
            font-family: var(--font-headline); font-weight: 600; font-size: 1.75rem;
            color: var(--yb-indigo); margin-bottom: 1.5rem; line-height: 1.3;
            border-bottom: 2px solid var(--yb-purple); padding-bottom: 0.5rem;
            display: inline-block;
        }

        /* Filter Controls Area */
        .filter-controls {
            margin-bottom: 1.5rem; display: flex; flex-wrap: wrap;
            gap: 1rem; padding: 1rem; background-color: var(--yb-gray-1);
            border-radius: 4px; border: 1px solid var(--yb-gray-3);
            align-items: center; /* Align items vertically */
        }
        .filter-group {
            display: flex; align-items: center;
            flex-basis: 280px; /* Default base width for Ticket, File */
            flex-grow: 1; /* Allow growing */
            gap: 0.5rem; /* Default gap within group */
        }
        /* --- NEW: Styling for the combined date range group --- */
        .filter-group-daterange {
            flex-basis: 550px; /* Increased base width to hold two inputs/labels */
            /* It still uses flex-grow: 1 from .filter-group */
        }
        .filter-group-daterange label[for="endDate"] {
             margin-left: 0.75rem; /* Add space before the "End:" label */
        }
        /* --- End NEW --- */

        .filter-controls label {
            font-weight: 600; color: var(--yb-indigo);
            flex-shrink: 0; white-space: nowrap;
        }
        .filter-controls select,
        .filter-controls input[type="datetime-local"] {
            padding: 0.4rem 0.6rem; border: 1px solid var(--yb-gray-5);
            border-radius: 4px; background-color: var(--yb-white);
            font-family: var(--font-primary); font-size: 0.9rem;
            flex-grow: 1; /* Allow inputs to grow within their group */
            min-width: 150px; /* Minimum width for usability */
            height: 36px; /* Consistent height */
        }
        /* Ensure inputs within the date range group don't grow excessively */
        .filter-group-daterange input[type="datetime-local"] {
             flex-grow: 1; /* Let them share the space */
             /* min-width: 180px; /* Adjust if needed */
        }


        /* Reset Button Styling */
        .filter-group-button {
             flex-grow: 0; flex-basis: auto;
             margin-left: auto; /* Push button towards the right on wider screens */
             padding-left: 1rem; /* Add some space before the button */
        }
        .yb-button {
            padding: 0.4rem 1rem; border-radius: 4px;
            font-family: var(--font-primary); font-size: 0.9rem; font-weight: 600;
            cursor: pointer; text-align: center; border: 1px solid transparent;
            transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;
            height: 36px; line-height: 1.4;
        }
        .yb-button-secondary {
            background-color: var(--yb-gray-3); border-color: var(--yb-gray-5); color: var(--yb-gray-11);
        }
        .yb-button-secondary:hover, .yb-button-secondary:focus {
            background-color: var(--yb-gray-5); border-color: var(--yb-gray-9); color: var(--yb-black); outline: none;
        }


        /* Table Styling */
        table.yb-table { width: 100%; border-collapse: collapse; border: 1px solid var(--yb-gray-3); border-radius: 4px; overflow: hidden; font-size: 0.95rem; }
        table.yb-table thead th { background-color: var(--yb-gray-1); color: var(--yb-indigo); font-family: var(--font-headline); font-weight: 600; text-align: left; padding: 0.8rem 1rem; border-bottom: 2px solid var(--yb-purple); cursor: pointer; position: relative; padding-right: 25px; }
        table.dataTable thead .sorting, table.dataTable thead .sorting_asc, table.dataTable thead .sorting_desc { background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1em 1em; }
        table.yb-table tbody td { padding: 0.8rem 1rem; border-bottom: 1px solid var(--yb-gray-3); vertical-align: middle; word-break: break-all; }
        table.dataTable.stripe tbody tr.odd { background-color: var(--yb-white); }
        table.dataTable.stripe tbody tr.even { background-color: var(--yb-gray-1); }
        table.dataTable.hover tbody tr:hover { background-color: #e9e7f5; }
        table.yb-table td a { color: var(--yb-orange); text-decoration: none; font-weight: 600; transition: color 0.2s ease; }
        table.yb-table td a:hover, table.yb-table td a:focus { color: #e04a27; text-decoration: underline; }
        .dataTables_empty { text-align: center; color: var(--yb-gray-9); padding: 2rem 1rem !important; font-style: italic; }
        .yb-table .empty-state { display: none; }

        /* Footer Styling */
        .yb-footer { text-align: center; padding: 1rem; margin-top: 2rem; font-size: 0.85rem; color: var(--yb-gray-9); }

        /* DataTables elements styling */
        .dataTables_wrapper .dataTables_length, .dataTables_wrapper .dataTables_filter, .dataTables_wrapper .dataTables_info, .dataTables_wrapper .dataTables_paginate { padding: 0.5rem 0; font-size: 0.9rem; }
        .dataTables_filter { display: none; }

        /* Responsive Adjustments */
        /* Adjust breakpoints and basis values as needed */
        @media (max-width: 1250px) { /* Example breakpoint */
             .filter-group { flex-basis: calc(50% - 1rem); } /* Two columns for standard groups */
             .filter-group-daterange { flex-basis: 100%; order: 3; } /* Date range takes full width below */
             .filter-group-button { flex-basis: 100%; order: 4; margin-left: 0; padding-left: 0; margin-top: 0.5rem; } /* Button below date range */
        }
        @media (max-width: 768px) {
            .container { margin: 1rem; padding: 1rem; }
            h2.page-title { font-size: 1.5rem; }
            table.yb-table th, table.yb-table td { padding: 0.6rem 0.8rem; }
            .yb-header { padding: 0.5rem 1rem; }
            .yb-logo-img { height: 28px; }
            .filter-controls { flex-direction: column; align-items: stretch; }
            /* All groups stack vertically */
            .filter-group, .filter-group-daterange, .filter-group-button {
                 flex-basis: auto; width: 100%; order: 0; /* Reset order */
                 margin-left: 0; padding-left: 0; margin-top: 0;
            }
             /* Adjust spacing within combined date group on mobile */
             .filter-group-daterange {
                 flex-wrap: wrap; /* Allow wrapping inside the date group itself */
             }
             .filter-group-daterange label { width: 100%; margin-bottom: 0.25rem; margin-left: 0 !important; } /* Labels stack above inputs */
             .filter-group-daterange input[type="datetime-local"] { min-width: calc(50% - 0.25rem); width: calc(50% - 0.25rem); } /* Inputs side-by-side below labels */
             .filter-group-button { margin-top: 1rem; }
        }

    </style>
</head>
<body>

    <header class="yb-header">
        <a href="/" class="yb-logo-link" aria-label="YugabyteDB Home">
            <img src="/resources/Yugabyte-Logo-Dark BG-RGB.svg" alt="YugabyteDB Logo" class="yb-logo-img">
            <!-- Flask example: {% raw %}src="{{ url_for('static', filename='resources/Yugabyte-Logo-Dark BG-RGB.svg') }}"{% endraw %} -->
        </a>
    </header>

    <main class="container">
        <h2 class="page-title">{{ title }}</h2>

        <!-- Filter Controls -->
        <div class="filter-controls">
             <!-- Ticket Number Filter -->
             <div class="filter-group">
                <label for="ticketFilter">Ticket Number:</label>
                <select id="ticketFilter" data-column-index="0">
                    <option value="">All Tickets</option>
                    <!-- Options populated by JS -->
                </select>
            </div>
             <!-- Analysis File Filter -->
             <div class="filter-group">
                <label for="fileFilter">Analysis File:</label>
                <select id="fileFilter" data-column-index="1">
                    <option value="">All Files</option>
                    <!-- Options populated by JS -->
                </select>
            </div>

            <!-- COMBINED Date/Time Range Filter -->
            <div class="filter-group filter-group-daterange">
                <label for="startDate">Start:</label> <!-- Shortened label -->
                <input type="datetime-local" id="startDate" data-column-index="2">

                <label for="endDate">End:</label> <!-- Shortened label -->
                <input type="datetime-local" id="endDate" data-column-index="2">
            </div>
            <!-- END COMBINED -->

            <!-- Reset Button -->
            <div class="filter-group-button">
                 <button type="button" id="resetFiltersBtn" class="yb-button yb-button-secondary">Reset Filters</button>
            </div>
            <!-- END Reset Button -->
        </div>

        <table id="analysisTable" class="yb-table display stripe hover">
            <thead>
                <tr>
                    <th>Ticket Number</th>
                    <th>Analysis File</th>
                    <th>Analysis Date</th> <!-- Target column index 2 -->
                </tr>
            </thead>
            <tbody>
                {% for item in analysis_items %}
                <tr>
                    <td>{{ item.case_number }}</td>
                    <td><a href="{{ item.filename }}">{{ item.filename }}</a></td>
                    <!-- Ensure format is YYYY-MM-DD HH:MM:SS or similar -->
                    <td>{{ item.analysis_date }}</td>
                </tr>
                {% else %}
                <tr class="empty-state">
                    <td colspan="3">No analysis files found (Initial load).</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </main>

    <footer class="yb-footer">
        &copy; {{ current_year }} Yugabyte, Inc. All rights reserved.
    </footer>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- DataTables JavaScript -->
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>

    <script>
        $(document).ready(function() {

            // --- Date/Time Range Filter Logic ---
            $.fn.dataTable.ext.search.push(
                function( settings, data, dataIndex ) {
                    if ( settings.nTable.id !== 'analysisTable' ) return true;
                    var minInputStr = $('#startDate').val(); var maxInputStr = $('#endDate').val();
                    var cellDateTimeStr = data[2] || '';
                    if (!cellDateTimeStr || cellDateTimeStr.toLowerCase() === 'none') return !minInputStr && !maxInputStr;
                    var comparableMin = minInputStr ? minInputStr.replace('T', ' ') : null;
                    var comparableMax = maxInputStr ? maxInputStr.replace('T', ' ') : null;
                    var comparableCell = null;
                    var cellMatch = cellDateTimeStr.match(/^(\d{4}-\d{2}-\d{2})\s?(\d{2}:\d{2})?:\d{2}?/);
                    if (cellMatch) { comparableCell = cellMatch[1]; if (cellMatch[2]) comparableCell += ' ' + cellMatch[2]; }
                    else if (/^\d{4}-\d{2}-\d{2}$/.test(cellDateTimeStr.trim())) { comparableCell = cellDateTimeStr.trim(); }
                    if (!comparableCell) { console.warn("Could not parse cell date/time:", cellDateTimeStr); return !minInputStr && !maxInputStr; }
                    if (comparableMin && comparableCell < comparableMin) return false;
                    if (comparableMax && comparableCell > comparableMax) return false;
                    return true;
                }
            );

            // Initialize DataTables
            var table = $('#analysisTable').DataTable({
                searching: true, language: { emptyTable: "No analysis files matching filters found.", zeroRecords: "No matching analysis files found" },
                order: [[2, 'desc']], columnDefs: [ { type: 'date', targets: 2 } ],
                initComplete: function () {
                    console.log("DataTables initComplete."); var api = this.api();
                    api.columns([0, 1]).every(function () {
                        var column = this; var columnIndex = column.index(); var select = $('select[data-column-index="' + columnIndex + '"]'); if (select.length === 0) return;
                        select.find('option:not(:first-child)').remove(); var uniqueData = column.data().unique().sort().toArray();
                        uniqueData.forEach(function (d) {
                            var displayValue = d; if (columnIndex === 1 && d) { displayValue = $(d).text(); }
                            var cleanData = displayValue ? $('<div>').text(displayValue).html() : '';
                            if (cleanData && cleanData.toLowerCase() !== 'none') { select.append($('<option>', { value: cleanData, text: cleanData })); }
                        });
                    });
                    $('select[data-column-index="0"], select[data-column-index="1"]').off('change').on('change', function () {
                        var columnIndex = $(this).data('column-index'); var val = $(this).val(); var escapedVal = $.fn.dataTable.util.escapeRegex(val || '');
                        console.log("Dropdown filter change on column", columnIndex, "Value:", val);
                        if (columnIndex === 1) { api.column(columnIndex).search(escapedVal, true, false).draw(); }
                        else { api.column(columnIndex).search(val ? '^' + escapedVal + '$' : '', true, false).draw(); }
                    });
                    $('#startDate, #endDate').off('change').on('change', function() { console.log("Date/Time filter changed."); api.draw(); });
                    $('#resetFiltersBtn').off('click').on('click', function() {
                        console.log("Resetting filters."); $('#ticketFilter, #fileFilter').val(''); $('#startDate, #endDate').val('');
                        api.columns([0, 1]).search(''); api.draw();
                    });
                 }
            });
        });
    </script>

</body>
</html>